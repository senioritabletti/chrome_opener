name: Release (signed APK)
on:
    push:
        tags:
            - "v*" # e.g., v1.0.2

permissions:
    contents: read

jobs:
    build-release:
        runs-on: macos-14
        environment: release
        permissions:
            contents: write
        steps:
            - uses: actions/checkout@v4

            - name: Set up JDK 21
              uses: actions/setup-java@v4
              with:
                  distribution: temurin
                  java-version: 21
                  cache: gradle

            - name: Decode keystore
              run: |
                  echo "$RELEASE_KEYSTORE_BASE64" | base64 -d > signing.keystore
              shell: bash
              env:
                  RELEASE_KEYSTORE_BASE64: ${{ secrets.RELEASE_KEYSTORE_BASE64 }}

            - name: Build release (signed)
              env:
                  RELEASE_STORE_FILE: ${{ github.workspace }}/signing.keystore
                  RELEASE_STORE_PASSWORD: ${{ secrets.RELEASE_STORE_PASSWORD }}
                  RELEASE_KEY_ALIAS: ${{ secrets.RELEASE_KEY_ALIAS }}
                  RELEASE_KEY_PASSWORD: ${{ secrets.RELEASE_KEY_PASSWORD }}
              run: |
                  ./gradlew --no-daemon clean :app:assembleRelease

            - name: Rename artifact
              run: |
                  mkdir -p dist
                  cp app/build/outputs/apk/release/app-release.apk "dist/chrome_opener-${GITHUB_REF_NAME}.apk"

            - name: Create GitHub Release
              uses: softprops/action-gh-release@v2
              with:
                  files: |
                      dist/chrome_opener-${{ github.ref_name }}.apk
                  generate_release_notes: true
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
