name: Release (APK with tag)

on:
    push:
        tags: ["v*"] # e.g., v1.0.0

permissions:
    contents: write

jobs:
    build:
        runs-on: macos-14

        # Map secrets to env first; use env.* in if: conditions
        env:
            RELEASE_KEYSTORE_BASE64: ${{ secrets.RELEASE_KEYSTORE_BASE64 }}
            RELEASE_STORE_PASSWORD: ${{ secrets.RELEASE_STORE_PASSWORD }}
            RELEASE_KEY_ALIAS: ${{ secrets.RELEASE_KEY_ALIAS }}
            RELEASE_KEY_PASSWORD: ${{ secrets.RELEASE_KEY_PASSWORD }}

        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Set up JDK 21
              uses: actions/setup-java@v4
              with:
                  distribution: temurin
                  java-version: 21
                  cache: gradle

            - name: Sanity check Java/Gradle
              run: |
                  echo "JAVA_HOME=$JAVA_HOME"
                  java -version
                  ./gradlew -version

            # Decode keystore ONLY if we actually have one
            - name: Decode signing keystore (optional)
              if: ${{ env.RELEASE_KEYSTORE_BASE64 != '' }}
              run: echo "$RELEASE_KEYSTORE_BASE64" | base64 -d > signing.keystore

            # Signed build path (requires env var above)
            - name: Build release (signed)
              if: ${{ env.RELEASE_KEYSTORE_BASE64 != '' }}
              env:
                  RELEASE_STORE_FILE: ${{ github.workspace }}/signing.keystore
                  RELEASE_STORE_PASSWORD: ${{ env.RELEASE_STORE_PASSWORD }}
                  RELEASE_KEY_ALIAS: ${{ env.RELEASE_KEY_ALIAS }}
                  RELEASE_KEY_PASSWORD: ${{ env.RELEASE_KEY_PASSWORD }}
              run: ./gradlew --no-daemon clean :app:assembleRelease

            # Unsigned build path (no secrets present)
            - name: Build release (unsigned)
              if: ${{ env.RELEASE_KEYSTORE_BASE64 == '' }}
              run: ./gradlew --no-daemon clean :app:assembleRelease

            - name: Prepare artifact with tag
              id: prep
              run: |
                  set -e
                  TAG="${GITHUB_REF_NAME}"
                  OUTDIR="app/build/outputs/apk/release"
                  SIGNED="${OUTDIR}/app-release.apk"
                  UNSIGNED="${OUTDIR}/app-release-unsigned.apk"

                  mkdir -p dist
                  if [ -f "$SIGNED" ]; then SRC="$SIGNED";
                  elif [ -f "$UNSIGNED" ]; then SRC="$UNSIGNED";
                  else echo "No release APK found in $OUTDIR"; ls -al "$OUTDIR" || true; exit 1; fi

                  DEST="dist/chrome_opener-${TAG}.apk"
                  cp "$SRC" "$DEST"
                  echo "apk_path=$DEST" >> "$GITHUB_OUTPUT"

            - name: Create/Update GitHub Release
              uses: softprops/action-gh-release@v2
              with:
                  files: ${{ steps.prep.outputs.apk_path }}
                  generate_release_notes: true
