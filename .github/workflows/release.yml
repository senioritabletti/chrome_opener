name: Release (signed APK)
on:
    push:
        tags:
            - "v*" # e.g., v1.0.2

permissions:
    contents: write

jobs:
    build:
        runs-on: macos-14

        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Set up JDK 21
              uses: actions/setup-java@v4
              with:
                  distribution: temurin
                  java-version: 21
                  cache: gradle

            - name: Build release
              run: ./gradlew --no-daemon clean :app:assembleRelease

            # Detect signed or unsigned output and rename with the tag
            - name: Prepare artifact with tag
              id: prep
              run: |
                  set -e
                  TAG="${GITHUB_REF_NAME}"
                  OUTDIR="app/build/outputs/apk/release"
                  SIGNED="${OUTDIR}/app-release.apk"
                  UNSIGNED="${OUTDIR}/app-release-unsigned.apk"

                  mkdir -p dist

                  if [ -f "$SIGNED" ]; then
                    SRC="$SIGNED"
                  elif [ -f "$UNSIGNED" ]; then
                    SRC="$UNSIGNED"
                  else
                    echo "No release APK found in ${OUTDIR}"
                    ls -al "${OUTDIR}" || true
                    exit 1
                  fi

                  DEST="dist/chrome_opener-${TAG}.apk"
                  cp "$SRC" "$DEST"
                  echo "apk_path=$DEST" >> $GITHUB_OUTPUT
                  echo "Renamed to $DEST"

            - name: Create/Update GitHub Release
              uses: softprops/action-gh-release@v2
              with:
                  files: ${{ steps.prep.outputs.apk_path }}
                  generate_release_notes: true
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
